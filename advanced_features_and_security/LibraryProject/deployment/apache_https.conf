# Apache Configuration for Django HTTPS Deployment
# This configuration file sets up Apache as a reverse proxy with HTTPS support

# Enable required modules
# LoadModule ssl_module modules/mod_ssl.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule headers_module modules/mod_headers.so

# Virtual Host for HTTP (redirect to HTTPS)
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    # Redirect all HTTP requests to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

# Virtual Host for HTTPS
<VirtualHost *:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLCertificateChainFile /path/to/your/chain.crt  # If you have a certificate chain
    
    # SSL Security Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; object-src 'none';"
    
    # Static files
    Alias /static/ /path/to/your/project/staticfiles/
    <Directory /path/to/your/project/staticfiles/>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </Directory>
    
    # Media files
    Alias /media/ /path/to/your/project/media/
    <Directory /path/to/your/project/media/>
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public"
    </Directory>
    
    # Django application proxy
    ProxyPreserveHost On
    ProxyPass /static/ !
    ProxyPass /media/ !
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # Proxy headers
    ProxyPassReverse / http://127.0.0.1:8000/
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto https
    RequestHeader set X-Forwarded-Port 443
    
    # Security: Block access to sensitive files
    <FilesMatch "\.(env|log|ini)$">
        Require all denied
    </FilesMatch>
    
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    # Logging
    ErrorLog /var/log/apache2/django_https_error.log
    CustomLog /var/log/apache2/django_https_access.log combined
</VirtualHost>

# Rate limiting configuration (requires mod_security)
# <IfModule mod_security2.c>
#     SecRuleEngine On
#     SecRule REQUEST_URI "@streq /admin/login/" "id:1001,phase:1,block,msg:'Rate limit exceeded'"
# </IfModule>
